name: Deploy to Azure Container Instances

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
  IMAGE_NAME: learnings-api

jobs:
  # ==========================================
  # JOB 1: Build and Push Docker Image
  # ==========================================
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Login to ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.REGISTRY_LOGIN_SERVER }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
          ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # ==========================================
  # JOB 2: Deploy to Staging (Automatic)
  # ==========================================
  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: http://${{ secrets.STAGING_CONTAINER_FQDN }}:8080
    
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Staging
      run: |
        echo "üöÄ Deploying to Staging..."
        az container restart \
          --name ${{ secrets.STAGING_CONTAINER_NAME }} \
          --resource-group ${{ secrets.RESOURCE_GROUP }}
        echo "‚úÖ Staging deployment complete!"
        echo "üîó Access at: http://${{ secrets.STAGING_CONTAINER_FQDN }}:8080/swagger"
    
    - name: Azure Logout
      run: az logout
      if: always()

  # ==========================================
  # JOB 3: Deploy to Production (Manual Approval Required)
  # ==========================================
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://${{ secrets.PROD_CONTAINER_FQDN }}:8080
    
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Production
      run: |
        echo "üöÄ Deploying to Production..."
        az container restart \
          --name ${{ secrets.PROD_CONTAINER_NAME }} \
          --resource-group ${{ secrets.RESOURCE_GROUP }}
        echo "‚úÖ Production deployment complete!"
        echo "üîó Access at: http://${{ secrets.PROD_CONTAINER_FQDN }}:8080/swagger"
    
    - name: Send Success Email
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "‚úÖ Production Deployment Successful - ${{ github.repository }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: DevOps Notifications <${{ secrets.EMAIL_USERNAME }}>
        body: |
          Production deployment completed successfully!
          
          üì¶ Repository: ${{ github.repository }}
          üîñ Commit: ${{ github.sha }}
          üë§ Triggered by: ${{ github.actor }}
          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          üåê Production URL: http://${{ secrets.PROD_CONTAINER_FQDN }}:8080/swagger
    
    - name: Send Failure Email
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "‚ùå Production Deployment Failed - ${{ github.repository }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: DevOps Notifications <${{ secrets.EMAIL_USERNAME }}>
        body: |
          Production deployment FAILED!
          
          üì¶ Repository: ${{ github.repository }}
          üîñ Commit: ${{ github.sha }}
          üë§ Triggered by: ${{ github.actor }}
          üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Please check the logs for details.
    
    - name: Azure Logout
      run: az logout
      if: always()